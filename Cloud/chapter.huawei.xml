<?xml version="1.0" encoding="UTF-8"?>
<chapter id="index"><?dbhtml dir="huawei" ?>
	<title>Huawei Cloud Service</title>
	<section id="flexus.server">
		<title>Flexus云服务器</title>
		<section>
			<title>AlmaLinux 9 镜像初始化</title>
			<section>
				<title>配置域名服务器</title>
				<para>默认域名服务器无法解析外部域名</para>
				<screen>
			<![CDATA[
[root@production ~]# ping www.netkiller.cn
ping: www.netkiller.cn: Name or service not known			
			]]>
				</screen>
				<para>100.79.1.250 内部域名服务器</para>
				<screen>
				<![CDATA[
[root@production ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
search openstacklocal
nameserver 100.79.1.250
options timeout:1 single-request-reopen				
				]]>
				</screen>
				<para>添加域名服务器</para>
				<screen>
				<![CDATA[
[root@production ~]# echo "nameserver 8.8.8.8" >> /etc/resolv.conf
				
[root@production ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
search openstacklocal
nameserver 100.79.1.250
options timeout:1 single-request-reopen
nameserver  8.8.8.8				
				]]>
				</screen>
				<para>测试域名解析是否正常</para>
				<screen>
				<![CDATA[
[root@production ~]# ping www.netkiller.cn
PING netkiller.github.io (185.199.111.153) 56(84) bytes of data.
^C64 bytes from 185.199.111.153: icmp_seq=4 ttl=48 time=124 ms

--- netkiller.github.io ping statistics ---
4 packets transmitted, 1 received, 75% packet loss, time 3058ms
rtt min/avg/max/mdev = 124.042/124.042/124.042/0.000 ms				
				]]>
				</screen>
			</section>
			<section>
				<title>员常用工具</title>
				<para>管理员常用工具</para>
				<screen>
			<![CDATA[
dnf install -y bzip2 tree psmisc \
telnet wget rsync vim-enhanced \
net-tools bind-utils			
			]]>
				</screen>
			</section>
			<section>
				<title>OpenJDK 17</title>
				<screen>
				<![CDATA[
[root@testing ~]# dnf install -y java-17-openjdk maven-openjdk17				
				]]>
				</screen>
			</section>



		</section>
	</section>
	<section id="flexus.rds">
		<title>Flexus RDS</title>
		<section>
			<title>迁移阿里云RDS至华为云RDS</title>
			<screen>
				<![CDATA[
[root@aliyun ~]# mysqldump -h aliyun.netkiller.cn -uroot -p watch | gzip > watch.sql.gz
				]]>
			</screen>
			<screen>
			<![CDATA[
[root@aliyun ~]# scp watch.sql.gz root@newdb.netkiller.cn			
			]]>
			</screen>
			<screen>
				<![CDATA[
[root@huawei ~]# zcat watch.sql.gz | mysql -h huawei.netkiller.cn -uroot -p development
				]]>
			</screen>
			<para>使用非root用户，迁移RDS会提示</para>
			<screen>
			<![CDATA[
[root@testing ~]# mysqldump -h rm-wz92171y2sukacse6co.mysql.rds.aliyuncs.com -unetkiller -p netkiller | gzip > netkiller.sql.gz
Enter password: 
Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don't want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. 
Warning: A dump from a server that has GTIDs enabled will by default include the GTIDs of all transactions, even those that were executed during its extraction and might not be represented in the dumped data. This might result in an inconsistent data dump. 
In order to ensure a consistent backup of the database, pass --single-transaction or --lock-all-tables or --master-data. 
(failed reverse-i-search)`scp': dnf install -y bzip2 tree psmi^C telnet wget rsync vim-enhanced net-tools bind-utils  			
			]]>
			</screen>
			<para>如果强行恢复数据库会提示</para>
			<screen>
			<![CDATA[
[root@testing ~]# zcat netkiller.sql.gz | mysql -h 192.168.0.219 -uroot -p production
Enter password: 
ERROR 1227 (42000) at line 18: Access denied; you need (at least one of) the SUPER, SYSTEM_VARIABLES_ADMIN or SESSION_VARIABLES_ADMIN privilege(s) for this operation
			]]>
			</screen>
			<para>解决方法，使用 --set-gtid-purged=OFF 参数备份数据库</para>
			<screen>
			<![CDATA[
[root@testing ~]# mysqldump -h rm-wz92171y2sukacse6co.mysql.rds.aliyuncs.com -unetkiller -p netkiller --set-gtid-purged=OFF | gzip > netkiller.sql.gz
Enter password: 
[root@testing ~]# 			
			]]>
			</screen>
			<para>恢复数据正常</para>
			<screen>
			<![CDATA[
[root@testing ~]# scp netkiller.sql.gz root@api.netkiller.cn:/root/
root@api.netkiller.cn's password: 
netkiller.sql.gz                                                                                                                                                                                              100%   18MB 219.8MB/s   00:00    
[root@testing ~]# 		
			]]>
			</screen>

			<screen>
			<![CDATA[
[root@testing ~]# zcat netkiller.sql.gz | mysql -h 192.168.0.219 -uroot -p production
Enter password: 
			]]>
			</screen>

		</section>
	</section>
</chapter>
